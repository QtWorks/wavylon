ЦИКЛ РЕНДЕРИНГА


0. CProject владеет списком дорожек:
 QList <CTrack *> tracks;

1. CProject::mixbuf_play начинает цикл рендеринга, запуская коллбэк воспроизведения, устанавливая начало дорожечного окна (tracks_window_start_frames) в место курсора (cursor_frames), а смещение внутри дорожечного окна (tracks_window_inner_offset) в ноль.

2. Каждая дорожка имеет CFloatBuffer *fbtrack. Это буфер, куда рендерятся клипы дорожки, попадающие в дорожечное окно. Окно всегда больше буфера звуковой подсистемы (buffer_size_frames) в buffer_size_frames_multiplier раз.

Для рендеринга клипов вызывается функция

size_t render_portion (size_t start_pos_, size_t window_length_frames);  
  
Вызывается она из CProject::tracks_render_next(), в которой идет проход по всем дорожкам проекта, а затем смещение начала дорожечного окна на tracks_window_length_frames.

Таким образом итог выполнения CProject::tracks_render_next() - буферы дорожек, заполненные в пределах очередного окна.

3. CProject::tracks_render_next() вызывается из основной функции коллбэка, которая отвечает за микширование - CProject::mixbuf_render_next

Каждый цикл микширования, длиной равный размеру буфера звуковой подсистемы, осуществляется в короткий буфер мастер-дорожки master_track->fb. В этот буфер кусками попадают сэмплы из буфера fbtrack каждой дорожки, внутри которой как бы смещается счетчик tracks_window_inner_offset (отмеряющий смещение очередной порции данных из буфера дорожки fbtrack). Если этот счетчик превышает размер окна, окно перемещается на следующую позицию (прибавляется размер окна (tracks_window_length_frames) к его началу), а счетчик tracks_window_inner_offset обнуляется.

  